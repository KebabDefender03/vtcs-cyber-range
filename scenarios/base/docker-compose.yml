# ============================================================================
# VTCS Cyber Range POC - Base Scenario Docker Compose
# ============================================================================
# This compose file creates the complete lab environment:
# - 3 Blue team workspaces (Blue1, Blue2, Blue3) - Kali Linux
# - 3 Red team workspaces (Red1, Red2, Red3) - Kali Linux
# - Target services (DVWA, database, workstation)
# - Isolated networks with controlled connectivity
#
# Resource limits are set to allow 6 concurrent users on 3 CPU cores
# ============================================================================

services:
  # ==========================================================================
  # BLUE TEAM WORKSPACES (Kali Linux)
  # ==========================================================================
  blue1:
    image: kalilinux/kali-rolling
    container_name: blue1
    hostname: blue1
    command: tail -f /dev/null
    networks:
      - blue_net
      - services_net  # Blue team can access services
    volumes:
      - blue1_home:/root
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  blue2:
    image: kalilinux/kali-rolling
    container_name: blue2
    hostname: blue2
    command: tail -f /dev/null
    networks:
      - blue_net
      - services_net
    volumes:
      - blue2_home:/root
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  blue3:
    image: kalilinux/kali-rolling
    container_name: blue3
    hostname: blue3
    command: tail -f /dev/null
    networks:
      - blue_net
      - services_net
    volumes:
      - blue3_home:/root
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  # ==========================================================================
  # RED TEAM WORKSPACES (Kali Linux)
  # ==========================================================================
  red1:
    image: kalilinux/kali-rolling
    container_name: red1
    hostname: red1
    command: tail -f /dev/null
    networks:
      - red_net
      - services_net  # Red team can access services (attack targets)
    volumes:
      - red1_home:/root
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  red2:
    image: kalilinux/kali-rolling
    container_name: red2
    hostname: red2
    command: tail -f /dev/null
    networks:
      - red_net
      - services_net
    volumes:
      - red2_home:/root
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  red3:
    image: kalilinux/kali-rolling
    container_name: red3
    hostname: red3
    command: tail -f /dev/null
    networks:
      - red_net
      - services_net
    volumes:
      - red3_home:/root
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  # ==========================================================================
  # TARGET SERVICES
  # ==========================================================================
  
  # DVWA - Damn Vulnerable Web Application (target for red team)
  webapp:
    image: vulnerables/web-dvwa
    container_name: webapp
    hostname: webapp
    networks:
      - services_net
    environment:
      - DB_SERVER=database
    ports:
      - "0.0.0.0:8080:80"
    depends_on:
      - database
    restart: unless-stopped

  # Database service for DVWA
  database:
    image: mysql:5.7
    container_name: database
    hostname: database
    networks:
      - services_net
    environment:
      - MYSQL_ROOT_PASSWORD=dvwa
      - MYSQL_DATABASE=dvwa
      - MYSQL_USER=dvwa
      - MYSQL_PASSWORD=p@ssw0rd
    volumes:
      - db_data:/var/lib/mysql
    restart: unless-stopped
  
  # Workstation (additional target)
  workstation:
    image: ubuntu:22.04
    container_name: workstation
    hostname: workstation
    command: tail -f /dev/null
    networks:
      - services_net
    restart: unless-stopped

# ============================================================================
# NETWORKS
# ============================================================================
# Isolated networks for segmentation. Default: no inter-network communication.
# Containers only see peers on their attached networks.
# ============================================================================

networks:
  # Blue team internal network
  blue_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.1.0/24
          gateway: 172.20.1.1
    driver_opts:
      com.docker.network.bridge.name: br-blue

  # Red team internal network
  red_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.2.0/24
          gateway: 172.20.2.1
    driver_opts:
      com.docker.network.bridge.name: br-red

  # Shared services network (targets accessible to both teams)
  services_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.3.0/24
          gateway: 172.20.3.1
    driver_opts:
      com.docker.network.bridge.name: br-services

# ============================================================================
# VOLUMES
# ============================================================================
# Persistent storage for workspaces and services.
# Reset by: docker compose down -v
# ============================================================================

volumes:
  # Workspace home directories
  blue1_home:
  blue2_home:
  blue3_home:
  red1_home:
  red2_home:
  red3_home:
  
  # Service data
  db_data:
