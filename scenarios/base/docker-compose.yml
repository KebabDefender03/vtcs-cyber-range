# ============================================================================
# VTCS Cyber Range POC - Base Scenario Docker Compose
# ============================================================================
# This compose file creates the complete lab environment:
# - 3 Blue team workspaces (Blue1, Blue2, Blue3)
# - 3 Red team workspaces (Red1, Red2, Red3)
# - Target services (web server, database)
# - Isolated networks with controlled connectivity
#
# Resource limits are set to allow 6 concurrent users on 3 CPU cores
# ============================================================================

services:
  # ==========================================================================
  # BLUE TEAM WORKSPACES
  # ==========================================================================
  blue1:
    build:
      context: ./images/workspace
      dockerfile: Dockerfile
    container_name: blue1
    hostname: blue1
    networks:
      - blue_net
      - services_net  # Blue team can access services
    environment:
      - WORKSPACE_NAME=Blue1
      - TEAM=blue
    volumes:
      - blue1_home:/home/student
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  blue2:
    build:
      context: ./images/workspace
      dockerfile: Dockerfile
    container_name: blue2
    hostname: blue2
    networks:
      - blue_net
      - services_net
    environment:
      - WORKSPACE_NAME=Blue2
      - TEAM=blue
    volumes:
      - blue2_home:/home/student
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  blue3:
    build:
      context: ./images/workspace
      dockerfile: Dockerfile
    container_name: blue3
    hostname: blue3
    networks:
      - blue_net
      - services_net
    environment:
      - WORKSPACE_NAME=Blue3
      - TEAM=blue
    volumes:
      - blue3_home:/home/student
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  # ==========================================================================
  # RED TEAM WORKSPACES
  # ==========================================================================
  red1:
    build:
      context: ./images/workspace
      dockerfile: Dockerfile
    container_name: red1
    hostname: red1
    networks:
      - red_net
      - services_net  # Red team can access services (attack targets)
    environment:
      - WORKSPACE_NAME=Red1
      - TEAM=red
    volumes:
      - red1_home:/home/student
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  red2:
    build:
      context: ./images/workspace
      dockerfile: Dockerfile
    container_name: red2
    hostname: red2
    networks:
      - red_net
      - services_net
    environment:
      - WORKSPACE_NAME=Red2
      - TEAM=red
    volumes:
      - red2_home:/home/student
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  red3:
    build:
      context: ./images/workspace
      dockerfile: Dockerfile
    container_name: red3
    hostname: red3
    networks:
      - red_net
      - services_net
    environment:
      - WORKSPACE_NAME=Red3
      - TEAM=red
    volumes:
      - red3_home:/home/student
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 2G
        reservations:
          memory: 512M
    restart: unless-stopped

  # ==========================================================================
  # TARGET SERVICES
  # ==========================================================================
  
  # Vulnerable web application (target for red team, monitored by blue team)
  webapp:
    build:
      context: ./images/webapp
      dockerfile: Dockerfile
    container_name: webapp
    hostname: webapp
    networks:
      - services_net
    environment:
      - DB_HOST=database
      - DB_NAME=${DB_NAME:-labdb}
      - DB_USER=${DB_USER:-labuser}
      - DB_PASS=${DB_PASS:-labpass123}
    ports:
      - "127.0.0.1:8080:80"  # Only accessible from Lab VM localhost
    depends_on:
      - database
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 1G
    restart: unless-stopped

  # Database service
  database:
    image: mysql:8.0
    container_name: database
    hostname: database
    networks:
      - services_net
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASS:-rootpass123}
      - MYSQL_DATABASE=${DB_NAME:-labdb}
      - MYSQL_USER=${DB_USER:-labuser}
      - MYSQL_PASSWORD=${DB_PASS:-labpass123}
    volumes:
      - db_data:/var/lib/mysql
      - ./init-db:/docker-entrypoint-initdb.d:ro
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 2G
    restart: unless-stopped

  # ==========================================================================
  # MONITORING (Optional - for blue team visibility)
  # ==========================================================================
  
  # Simple log aggregator (optional, can be removed to save resources)
  # logserver:
  #   image: grafana/loki:2.9.0
  #   container_name: logserver
  #   networks:
  #     - blue_net
  #   volumes:
  #     - loki_data:/loki
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.2'
  #         memory: 512M
  #   restart: unless-stopped

# ============================================================================
# NETWORKS
# ============================================================================
# Isolated networks for segmentation. Default: no inter-network communication.
# Containers only see peers on their attached networks.
# ============================================================================

networks:
  # Blue team internal network
  blue_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.1.0/24
          gateway: 172.20.1.1
    driver_opts:
      com.docker.network.bridge.name: br-blue

  # Red team internal network
  red_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.2.0/24
          gateway: 172.20.2.1
    driver_opts:
      com.docker.network.bridge.name: br-red

  # Shared services network (targets accessible to both teams)
  services_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.3.0/24
          gateway: 172.20.3.1
    driver_opts:
      com.docker.network.bridge.name: br-services

# ============================================================================
# VOLUMES
# ============================================================================
# Persistent storage for workspaces and services.
# Reset by: docker compose down -v
# ============================================================================

volumes:
  # Workspace home directories
  blue1_home:
  blue2_home:
  blue3_home:
  red1_home:
  red2_home:
  red3_home:
  
  # Service data
  db_data:
  # loki_data:
